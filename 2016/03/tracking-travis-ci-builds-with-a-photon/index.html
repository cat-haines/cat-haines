<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Tracking Travis CI Builds with a Photon</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Personal home page of Cat Haines. I blog about code, community, and creativity.
">
        <link rel="canonical"
        href="/2016/03/tracking-travis-ci-builds-with-a-photon/">

        <!-- Harmony styles -->
        <link rel="stylesheet" type="text/css" href="/assets/css/main.css">

        <!-- Modernizr js -->
        <script async src="/assets/js/modernizr.js"></script>

        <!-- IE Fixes -->
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body class="darken">
        <header class="main-header">
            <div class="wc-container">
                <h1><a href="/">Cat Haines</a></h1>
                <h2></h2>
                <ul>
  <li><a href="/">Home</a><span>/</span></li>
  <li><a href="/blog">Blog</a><span>/</span></li>
  <li><a href="/slides">Slides</a><span>/</span></li>
  <li><a href="/about">About</a><span>/</span></li>
</ul>

            </div>
        </header>
        <div class="page-content wc-container">
	<div class="post">
		<h1>Tracking Travis CI Builds with a Photon</h1>
		<p class="post-meta">
			
      Filed under:
      <span class="categories">
      code, travis, and photon
      </span> |
	    
	    <span class="post-date">
    	Mar 26, 2016
	    </span>
		</p>
		<div class="post">
			<p>A couple weeks ago I ran a workshop at a <a href="https://www.meetup.com/nodebotssf/">Nodebots meetup</a> about building a <a href="/slides/nodebots-travis-ci">Johnny-Five Powered Travis CI Build Indicator</a>. One of the goals of the workshop was to introduce people to a bunch of cool tools they may or may not have used before.. <a href="https://travis-ci.org">Travis CI</a>, <a href="http://johnny-five.io">Johnny-Five</a>, <a href="https://ifttt.com">IFTTT</a>, and <a href="https://ngrok.com">ngrok</a>.</p>

<p>Today we’re going to look at how we can build the project with a <a href="https://docs.particle.io/guide/getting-started/intro/photon/">Photon</a>, a tiny bit of <a href="http://playground.arduino.cc/Interfacing/Processing">Processing</a>, and some cURL commands!</p>

<!-- more -->

<p><strong>NOTE:</strong> <em>This project assumes a basic understanding of Travis CI, and working with the Photon. If you are unfamiliar with these topics, I encourage you to checkout <a href="https://docs.travis-ci.com/user/for-beginners">Travis CI for Complete Beginners</a>, and Particle’s <a href="https://docs.particle.io/guide/getting-started/start/core/">Getting Started Guide</a>.</em></p>

<h2 id="the-photon-side-of-things">The Photon Side of Things</h2>

<p>We’re going to create a basic circuit for an RGB LED, and flash our Proton with a tiny bit of code to control that LED through HTTP requests!</p>

<p><img src="/assets/imgs/blog/2016-03-26/circuit.png" alt="Circuit" /></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define GREEN_PIN   D0
#define RED_PIN     D1
#define BLUE_PIN    D2
</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Configure pins and set defaults
</span>  <span class="n">pinMode</span><span class="p">(</span><span class="n">RED_PIN</span><span class="p">,</span>   <span class="n">OUTPUT</span><span class="p">);</span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RED_PIN</span><span class="p">,</span>   <span class="n">LOW</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">GREEN_PIN</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">GREEN_PIN</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">BLUE_PIN</span><span class="p">,</span>  <span class="n">OUTPUT</span><span class="p">);</span>  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">BLUE_PIN</span><span class="p">,</span>  <span class="n">LOW</span><span class="p">);</span>

  <span class="n">Spark</span><span class="p">.</span><span class="n">function</span><span class="p">(</span><span class="s">"setcolor"</span><span class="p">,</span> <span class="n">setColor</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="kt">void</span> <span class="nf">setLeds</span><span class="p">(</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">analogWrite</span><span class="p">(</span><span class="n">RED_PIN</span><span class="p">,</span>   <span class="n">constrain</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">));</span>
    <span class="n">analogWrite</span><span class="p">(</span><span class="n">GREEN_PIN</span><span class="p">,</span> <span class="n">constrain</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">));</span>
    <span class="n">analogWrite</span><span class="p">(</span><span class="n">BLUE_PIN</span><span class="p">,</span>  <span class="n">constrain</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">setColor</span><span class="p">(</span><span class="n">String</span> <span class="n">color</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span><span class="s">"off"</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">setLeds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span><span class="s">"green"</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">setLeds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span><span class="s">"yellow"</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">setLeds</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">equalsIgnoreCase</span><span class="p">(</span><span class="s">"red"</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">setLeds</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">//  Unknown color
</span>    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// Success
</span><span class="p">}</span>
</code></pre>
</div>

<p>The code is also pretty basic - we configure and initialize three output pins, then expose the <code class="highlighter-rouge">setColor</code> method as a <a href="https://docs.particle.io/reference/firmware/photon/">Cloud Function</a>, which will be accessible through the Partical’s <a href="https://docs.particle.io/reference/api/">Cloud API</a>.</p>

<h4 id="testing-our-setup">Testing Our Setup</h4>

<p>If you assembled your circuit correctly, and successfully flashed your device with the above firmware code, you should be able to make the following <code class="highlighter-rouge">cURL</code> requests to change the color of your LED:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>curl -X POST https://api.particle.io/v1/devices/<span class="nv">$PARTICLE_DEVICE_ID</span>/setcolor <span class="se">\</span>
  -d <span class="nv">access_token</span><span class="o">=</span><span class="nv">$PARTICLE_TOKEN</span> <span class="se">\</span>
  -d <span class="nv">arg</span><span class="o">=</span>red

curl -X POST https://api.particle.io/v1/devices/<span class="nv">$PARTICLE_DEVICE_ID</span>/setcolor <span class="se">\</span>
  -d <span class="nv">access_token</span><span class="o">=</span><span class="nv">$PARTICLE_TOKEN</span> <span class="se">\</span>
  -d <span class="nv">arg</span><span class="o">=</span>yellow

curl -X POST https://api.particle.io/v1/devices/<span class="nv">$PARTICLE_DEVICE_ID</span>/setcolor <span class="se">\</span>
  -d <span class="nv">access_token</span><span class="o">=</span><span class="nv">$PARTICLE_TOKEN</span> <span class="se">\</span>
  -d <span class="nv">arg</span><span class="o">=</span>green

curl -X POST https://api.particle.io/v1/devices/<span class="nv">$PARTICLE_DEVICE_ID</span>/setcolor <span class="se">\</span>
  -d <span class="nv">access_token</span><span class="o">=</span><span class="nv">$PARTICLE_TOKEN</span> <span class="se">\</span>
  -d <span class="nv">arg</span><span class="o">=</span>off
</code></pre>
</div>

<p><strong>NOTE:</strong> <em>You’ll need to replace <code class="highlighter-rouge">$PARTICLE_DEVICE_ID</code> and <code class="highlighter-rouge">$PARTICLE_TOKEN</code> with your Device ID and Particle API Token (or better yet, <code class="highlighter-rouge">export</code> the values as environment variables).</em></p>

<h2 id="meanwhile-in-travis-ci">Meanwhile, in Travis CI…</h2>

<p>With our Particle running the above code, creating a Travis CI integration becomes incredibly simple. All we’re going to do is make the same <code class="highlighter-rouge">cURL</code> requsts we did above, but at specific times throughout the build lifecycle.</p>

<p>The first thing we’ll need to do is add our API Token and Device ID to the <code class="highlighter-rouge">.travis.yml</code> file. Since this is sensitive information, we’ll want to make use of Travis’ <code class="highlighter-rouge">encrypt</code> function:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>travis encrypt <span class="nv">PARTICLE_DEVICE_ID</span><span class="o">=</span><span class="s2">"your_device_id"</span> --add env.global
travis encrypt <span class="nv">PARTICLE_TOKEN</span><span class="o">=</span><span class="s2">"your_token"</span> --add env.global
</code></pre>
</div>

<p>If this worked, your <code class="highlighter-rouge">.travis.yml</code> file should now contain something that looks like the following (I’ve truncated the values for readability):</p>

<div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">env</span><span class="pi">:</span>
  <span class="s">global</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">secure</span><span class="pi">:</span> <span class="s">owjfRWVpTjNHmdijbyvOkk0AslnQ1hX3vNUvnsn5rQUa...</span>
  <span class="pi">-</span> <span class="s">secure</span><span class="pi">:</span> <span class="s">g2Dqz+LIvGe2do6Z/hAnrQBAcJLS7w6eQli6Bn+wDc4V...</span>
</code></pre>
</div>

<p>Next, we’ll create a bash script to wrap up our <code class="highlighter-rouge">cURL</code> command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

curl -X POST https://api.particle.io/v1/devices/<span class="nv">$PARTICLE_DEVICE_ID</span>/setcolor <span class="se">\</span>
  -d <span class="nv">access_token</span><span class="o">=</span><span class="nv">$PARTICLE_TOKEN</span> <span class="se">\</span>
  -d <span class="nv">arg</span><span class="o">=</span><span class="nv">$1</span>
</code></pre>
</div>

<p>And that’s basically it - we can run this script anytime we want to change the color of our LED, and by calling this script throughout the build lifecycle we can easily indicate the current state (in-progress, success, failure) with our LED.</p>

<p>Here’s how my build process looks like as defined in my <code class="highlighter-rouge">.travis.yml</code> file</p>

<div class="highlighter-rouge"><pre class="highlight"><code>before_install:
- "chmod +x ./travis-scripts/*.sh"
- "./travis-scripts/indicator/indicator.sh yellow"

script: "./travis-scripts/build.sh"

after_success: "./travis-scripts/indicator/indicator.sh green"
after_failure: "./travis-scripts/indicator/indicator.sh red"
</code></pre>
</div>

<p>The full source for this project, including the firmware, can be found on <a href="https://github.com/cat-haines/johnny-five-build-light/tree/photon/">GitHub</a>.</p>

<p>Happy Hacking!</p>


			 <3 Cat 😸 
		</div>
	</div>


	
	<div class="related">
		<h4>Related Posts</h2>
		<ul class="posts">
		    
		    <li>
			  <span>11 Mar 2016 &raquo;</span>
			  <a href="/2016/03/building-pebble-apps-with-travis-ci/">Building Pebble Apps with Travis CI</a>
		    </li>
		    
		    <li>
			  <span>28 Feb 2016 &raquo;</span>
			  <a href="/2016/02/starting-over/">Starting over</a>
		    </li>
		    
		</ul>
	</div>
	

	<div class="post-footer">
		<div class="column-1">
			
				<a href="/2016/03/building-pebble-apps-with-travis-ci/"><< Older</a>
			
		</div>
		<div class="column-2"><a href="/">Home</a></div>
		<div class="column-3">
			
				<span>Newer >></span>
			
		</div>
	</div>
</div>

        <footer class="main-footer">
            <div class="wc-container">
                <div class="column one">
                    <h6>Few more links</h6>
<ul class="menu">
    <li><a href="/about">About</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/slides">Slides</a></li>
    <li><a href="https://jekyllrb.com/">Jekyll</a></li>
</ul>

                </div>
                <div class="column two">
                    <h6>Follow me</h6>

<ul class="social-media">

    
    <li>
        <a title="_cathaines Twitter"
            href="https://twitter.com/_cathaines"
            class="twitter wc-img-replace" target="_blank">Twitter</a>
    </li>
    

    
    <li>
        <a title="cathaines on Medium"
            href="https://medium.com/@cathaines"
            class="medium wc-img-replace" target="_blank">Medium</a>
    </li>
    

    
    <li>
        <a title="cat-haines on Github"
            href="https://github.com/cat-haines"
            class="github wc-img-replace" target="_blank">Github</a>
    </li>
    

    

    

    

    

</ul>

                </div>
            </div>
            <p class="wc-container disclaimer">
                
            </p>
        </footer>
        <script type="text/javascript">
          /* To avoid render blocking css */
          var cb = function() {
            var l = document.createElement('link'); l.rel = 'stylesheet';
            l.href = 'http://fonts.googleapis.com/css?family=Ubuntu+Mono&subset=latin';
            var h = document.getElementsByTagName('head')[0]; h.parentNode.insertBefore(l, h);
          };
          var raf = requestAnimationFrame || mozRequestAnimationFrame ||
              webkitRequestAnimationFrame || msRequestAnimationFrame;
          if (raf) raf(cb);
          else window.addEventListener('load', cb);
        </script>
        <!-- jQuery -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- When no internet load JQuery from local -->
        <script>window.jQuery || document.write('<script src="/assets/js/jquery.min.js"><\/script>')</script>
        <!-- Site js -->
        <script src="/assets/js/all.js"></script>
        <!-- Google analytics  -->
        
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-74437010-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    </body>
</html>
